<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Alley‚Äôs RDR2 Companion ‚Äì Hunt ‚Ä¢ Craft ‚Ä¢ Complete</title>
  <meta name="description" content="Mobile-first Red Dead Redemption 2 companion for Alley: hunting, crafting, completion tracking, pins, and personalized profile with cats. Offline-first using localStorage. Export/Import JSON and Share." />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #111827;
      --muted: #a3b1c6;
      --text: #e6eefc;
      --accent: #30a46c; /* default green */
      --accent-2: #7c3aed;
      --danger: #ef4444;
      --warning: #f59e0b;
      --ok: #22c55e;
      --card: #0f172a;
      --border: #203047;
    }
    /* Theme accents ‚Äì we toggle data-theme on <html> */
    html[data-theme="gold"] { --accent:#d4a72c; --accent-2:#8b5cf6; }
    html[data-theme="rose"] { --accent:#e11d48; --accent-2:#22d3ee; }
    html[data-theme="sky"]  { --accent:#0ea5e9; --accent-2:#f97316; }

    * { box-sizing: border-box; }
    html, body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position: sticky; top: 0; z-index: 5; backdrop-filter: saturate(150%) blur(6px); background: rgba(11,15,20,0.85); border-bottom: 1px solid var(--border); }
    header .bar { display: flex; gap: 8px; align-items: center; padding: env(safe-area-inset-top) 12px 12px 12px; }
    h1 { font-size: 18px; margin: 0; letter-spacing: 0.3px; }
    .pill { padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; }
    .tabs { display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; padding: 6px 12px 10px; }
    .tab { padding: 8px 10px; text-align: center; border-radius: 12px; background: var(--panel); color: var(--muted); border: 1px solid var(--border); font-size: 12px; }
    .tab.active { background: linear-gradient(180deg, #1a2336, #0f172a); color: white; border-color: #2a3f66; }
    main { padding: 10px 12px 90px; }
    .grid { display: grid; gap: 10px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 12px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row.right { justify-content: flex-end; }
    .title { font-weight: 800; font-size: 16px; }
    .sub { font-size: 12px; color: var(--muted); }
    .kpi { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .k { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align:center; }
    .k .v { font-size: 18px; font-weight: 800; }
    .k .l { font-size: 11px; color: var(--muted); }
    input, select, button, textarea { font: inherit; color: inherit; }
    input, select, textarea { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 10px; }
    button { background: var(--panel); border: 1px solid var(--border); padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    button.primary { background: linear-gradient(180deg, color-mix(in hsl, var(--accent) 75%, black), color-mix(in hsl, var(--accent) 55%, black)); border-color: var(--accent); color: white; }
    button.ghost { background: transparent; border-color: var(--border); }
    button.warn { background: #3a1e11; border-color: #6b2f14; color: #ffb86b; }
    .list { display: grid; gap: 8px; }
    .item { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 10px; }
    .item .hdr { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .badge { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .tag { font-size: 11px; padding: 4px 8px; border-radius: 999px; background: #0d2231; border: 1px solid #1d3650; }
    .muted { color: var(--muted); }
    .fab { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 10; }
    .srch { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    .foot { position: fixed; bottom: 0; left: 0; right: 0; backdrop-filter: saturate(150%) blur(6px); background: rgba(11,15,20,0.9); border-top: 1px solid var(--border); padding: 10px 12px calc(10px + env(safe-area-inset-bottom)); display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px; }
    .foot button { border-radius: 12px; padding: 10px; }
    .small { font-size: 12px; }
    .hide { display: none !important; }
    .progress-ring { width: 86px; height: 86px; border-radius: 50%; background: conic-gradient(var(--accent) var(--p,0%), #22324a 0%); display: grid; place-items: center; font-weight: 800; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; display:grid; place-items:center; background: color-mix(in hsl, var(--accent) 25%, black); border:1px solid var(--border); }
    .chip { padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0d1a27; color:var(--text); font-size:12px; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="avatar" title="Alley">üê±</div>
      <div class="pill">Alley‚Äôs Companion</div>
      <h1>RDR2 ‚Äì Hunt ‚Ä¢ Craft ‚Ä¢ Complete</h1>
      <div style="flex:1"></div>
      <button id="btnExport" title="Export your data">Export</button>
      <button id="btnImport" title="Import saved data">Import</button>
      <button id="btnShare" title="Share" class="ghost">Share</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="hunt">Hunt</div>
      <div class="tab" data-tab="craft">Craft</div>
      <div class="tab" data-tab="challenges">Challenges</div>
      <div class="tab" data-tab="complete">100%</div>
      <div class="tab" data-tab="profile">Profile</div>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">Tonight's Targets</div>
            <div class="sub">Pins & smart suggestions for <span id="ownerNameInline">Alley</span></div>
            <div id="pinnedChips" class="row" style="margin-top:6px"></div>
          </div>
          <div class="progress-ring" id="pctComplete">0%</div>
        </div>
        <div id="homeSuggestions" class="list" style="margin-top:8px"></div>
      </div>

      <div class="card kpi">
        <div class="k"><div class="v" id="kPelts">0</div><div class="l">Perfect Pelts</div></div>
        <div class="k"><div class="v" id="kCraft">0</div><div class="l">Crafted Items</div></div>
        <div class="k"><div class="v" id="kCheck">0</div><div class="l">Checklist Done</div></div>
      </div>

      <div class="card">
        <div class="row"><div class="title">Quick Log</div></div>
        <div class="srch" style="margin-top:8px">
          <input id="logAnimal" placeholder="Animal name (e.g., Whitetail Buck)" />
          <select id="logQuality">
            <option value="3">Perfect ‚òÖ‚òÖ‚òÖ</option>
            <option value="2">Good ‚òÖ‚òÖ</option>
            <option value="1">Poor ‚òÖ</option>
          </select>
        </div>
        <div class="row right" style="margin-top:8px">
          <button class="primary" id="btnLogKill">Log Kill</button>
          <button class="ghost" id="btnQuickMat">+ Material</button>
        </div>
      </div>
    </section>

    <!-- HUNT -->
    <section id="hunt" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Find Animals</div></div>
        <div class="row" style="gap:8px; margin-top:8px">
          <input id="qHunt" placeholder="Search animal or family (e.g., pronghorn, deer)" style="flex:1" />
          <select id="fltRegion"></select>
          <select id="fltTime">
            <option value="">Any Time</option>
            <option value="day">Day</option>
            <option value="night">Night</option>
          </select>
        </div>
      </div>
      <div id="listAnimals" class="list"></div>
    </section>

    <!-- CRAFT -->
    <section id="craft" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Craftable Now</div><span class="sub">Based on your inventory</span></div>
      </div>
      <div id="listCraftable" class="list"></div>
      <div class="card"><div class="title">All Recipes</div></div>
      <div id="listRecipes" class="list"></div>
    </section>

    <!-- CHALLENGES -->
    <section id="challenges" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Challenges</div><span class="sub">Tap to toggle completion</span></div>
      </div>
      <div id="listChallenges" class="list"></div>
    </section>

    <!-- 100% -->
    <section id="complete" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">100% Checklist</div><span class="sub">Track major milestones</span></div>
      </div>
      <div id="listChecklist" class="list"></div>
    </section>

    <!-- PROFILE / SETTINGS -->
    <section id="profile" class="grid hide">
      <div class="card">
        <div class="row" style="justify-content:space-between;gap:12px">
          <div class="row" style="gap:10px">
            <div class="avatar" id="pfp">üê±</div>
            <div>
              <div class="title">Profile</div>
              <div class="sub">Make it yours, Alley</div>
            </div>
          </div>
          <div class="chip" id="installHint">Add to Home Screen ‚ûú</div>
        </div>
        <div class="row" style="margin-top:10px; gap:8px">
          <input id="ownerName" placeholder="Owner name" style="flex:1" />
          <select id="theme">
            <option value="green">Green</option>
            <option value="gold">Gold</option>
            <option value="rose">Rose</option>
            <option value="sky">Sky</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px; gap:8px">
          <input id="cats" placeholder="Cats (comma separated)" style="flex:1" />
        </div>
        <div class="row" style="margin-top:8px; gap:8px">
          <label class="sub"><input type="checkbox" id="spoilers"/> Show spoilers</label>
        </div>
        <div class="row right" style="margin-top:8px">
          <button class="primary" id="saveProfile">Save</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Pinned targets</div>
        <div class="sub">Your shortlist for tonight</div>
        <div id="pins" class="row" style="margin-top:8px;gap:6px;flex-wrap:wrap"></div>
        <div class="row right" style="margin-top:8px">
          <button class="ghost" id="clearPins">Clear Pins</button>
        </div>
      </div>
    </section>
  </main>

  <div class="foot">
    <button class="tab active" data-tab="home">Home</button>
    <button class="tab" data-tab="hunt">Hunt</button>
    <button class="tab" data-tab="craft">Craft</button>
    <button class="tab" data-tab="challenges">Challenges</button>
    <button class="tab" data-tab="complete">100%</button>
    <button class="tab" data-tab="profile">Profile</button>
  </div>

  <script>
  // ======== Minimal data layer (expandable) ========
  const DBKEY = 'rdr2_companion_v2_alley';
  const db = JSON.parse(localStorage.getItem(DBKEY) || 'null') || seed();
  function save() { localStorage.setItem(DBKEY, JSON.stringify(db)); renderAll(); }

  function seed(){
    const regions = [
      {id:'new_hanover', name:'New Hanover', states:['Heartlands','Grizzlies East']},
      {id:'west_elizabeth', name:'West Elizabeth', states:['Big Valley','Tall Trees']},
      {id:'lemoyne', name:'Lemoyne', states:['Bayou Nwa','Scarlett Meadows']},
      {id:'ambarino', name:'Ambarino', states:['Grizzlies West','Cotorra Springs']}
    ];

    const vendors = [
      {id:'trapper_stdenis', type:'Trapper', name:'Trapper ‚Äì Saint Denis', regionId:'lemoyne', near:'Market by the docks', lat:0, lng:0},
      {id:'trapper_bigvalley', type:'Trapper', name:'Trapper ‚Äì Big Valley', regionId:'west_elizabeth', near:'NW of Riggs Station', lat:0, lng:0},
      {id:'fence_stdenis', type:'Fence', name:'Fence ‚Äì Saint Denis', regionId:'lemoyne', near:'Rue de la Commerce', lat:0, lng:0},
      {id:'pearson_camp', type:'Pearson', name:'Pearson ‚Äì Camp', regionId:'new_hanover', near:'Camp crafting', lat:0, lng:0}
    ];

    const animals = [
      {id:'whitetail_buck', name:'Whitetail Buck', family:'deer', regionIds:['new_hanover','west_elizabeth'], habitatNotes:'Open woodlands and meadows; dawn/dusk active', activeTimes:['day','night']},
      {id:'pronghorn', name:'Pronghorn', family:'antelope', regionIds:['new_hanover','west_elizabeth'], habitatNotes:'Heartlands plains; skittish', activeTimes:['day']},
      {id:'american_bison', name:'American Bison', family:'bison', regionIds:['west_elizabeth'], habitatNotes:'Big Valley grasslands', activeTimes:['day']},
      {id:'rabbit', name:'Black-tailed Jackrabbit', family:'small_game', regionIds:['lemoyne','new_hanover','west_elizabeth'], habitatNotes:'Everywhere', activeTimes:['day','night']},
      {id:'bear_grizzly', name:'Grizzly Bear', family:'bear', regionIds:['ambarino','west_elizabeth'], habitatNotes:'Grizzlies; aggressive', activeTimes:['day']}
    ];

    const huntRules = [
      {animalId:'whitetail_buck', perfectPelt:3, weapon:'Bolt Action Rifle', ammo:'Express', shots:'1x head or heart', notes:'Use cover scent; approach from downwind'},
      {animalId:'pronghorn', perfectPelt:3, weapon:'Varmint Rifle', ammo:'Regular', shots:'1x headshot', notes:'Keep distance; prone in grass'},
      {animalId:'american_bison', perfectPelt:3, weapon:'Springfield/Bolt Action', ammo:'Express', shots:'1x head', notes:'Aim for brain; use Dead Eye'},
      {animalId:'rabbit', perfectPelt:3, weapon:'Varmint Rifle', ammo:'Regular', shots:'1x head', notes:'Small game arrows also work'},
      {animalId:'bear_grizzly', perfectPelt:3, weapon:'Bolt Action Rifle', ammo:'Express', shots:'1x head', notes:'Bring potent tonics; bait optional'}
    ];

    const legendary = [
      {id:'legendary_bharati_bear', name:'Legendary Bharati Grizzly', regionId:'ambarino', clueCount:3, peltOutputs:['Legendary Bear Pelt'], trinkets:['Bear Claw Talisman'], time:['day'], weather:['clear']}
    ];

    const recipes = [
      {id:'trapper_bear_hat', name:'Grizzly Mountain Hat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Legendary Bear Pelt', qty:1}], outputs:[{item:'Grizzly Mountain Hat', qty:1}], notes:'Craft at any Trapper'},
      {id:'pearson_satchel_kit', name:'Arthur Full Satchel Kit', station:'Camp', vendorType:'Pearson', inputs:[{item:'Perfect Deer Pelt', qty:3},{item:'Perfect Bison Pelt', qty:1},{item:'Perfect Pronghorn Hide', qty:1}], outputs:[{item:'Legend of the East Satchel (part)', qty:1}], requires:['Upgrade Leather Working Tools']},
      {id:'fence_trinket_bear', name:'Bear Claw Talisman', station:'Fence', vendorType:'Fence', inputs:[{item:'Legendary Bear Claw', qty:1},{item:'Silver Chain Bracelet', qty:1},{item:'Quartz Chunk', qty:1}], outputs:[{item:'Bear Claw Talisman', qty:1}], notes:'Permanent stamina core drain reduction'}
    ];

    const challenges = [
      {id:'survivalist_1', category:'Survivalist', tier:1, description:'Catch 3 Bluegill', requirements:['3x Bluegill caught']},
      {id:'master_hunter_1', category:'Master Hunter', tier:1, description:'Skin 3 deer', requirements:['3x Deer skinned']},
      {id:'sharpshooter_1', category:'Sharpshooter', tier:1, description:'Kill 3 flying birds', requirements:['3x birds shot mid-flight']}
    ];

    const checklist = [
      {id:'cl_legendary_bear', kind:'collectible', label:'Legendary Bharati Bear ‚Äì Hunted', regionId:'ambarino'},
      {id:'cl_bear_trinket', kind:'trinket', label:'Bear Claw Talisman ‚Äì Crafted'},
      {id:'cl_satchel', kind:'satchel', label:'Satchel Upgrades Completed'}
    ];

    const inventory = { pelts:[], materials:[] };

    const events = [];
    const settings = { spoilers:false, preferredUnits:'imperial', showMap:false };
    const profile = { ownerName:'Alley', cats:['Mittens','Pumpkin'], theme:'green' };
    const pins = { animals:[], recipes:[] };

    return { regions, vendors, animals, huntRules, legendary, recipes, challenges, checklist, inventory, events, settings, profile, pins };
  }

  const qs = s=>document.querySelector(s);
  const qsa = s=>Array.from(document.querySelectorAll(s));
  const vibrate = ms=> (navigator.vibrate? navigator.vibrate(ms): false);
  function percent(n,d){ return d? Math.round((n/d)*100):0; }

  // ======== Rendering ========
  function renderTabs() {
    qsa('.tab').forEach(t=>{
      t.onclick = () => {
        qsa('.tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        qsa('main section').forEach(sec=>sec.classList.add('hide'));
        qs('#'+t.dataset.tab).classList.remove('hide');
      };
    });
  }

  function renderHome() {
    qs('#ownerNameInline').textContent = db.profile.ownerName || 'Alley';

    // KPIs
    const perfectCount = db.inventory.pelts.filter(p=>p.quality===3).reduce((a,b)=>a+b.qty,0);
    const crafted = db.events.filter(e=>e.type==='craft').length;
    const done = db.checklist.filter(x=>x.done).length;
    qs('#kPelts').textContent = perfectCount;
    qs('#kCraft').textContent = crafted;
    qs('#kCheck').textContent = done;
    const pct = percent(done, db.checklist.length);
    const ring = qs('#pctComplete');
    ring.style.setProperty('--p', pct+'%');
    ring.textContent = pct+'%';

    // Pinned chips
    const chips = qs('#pinnedChips'); chips.innerHTML='';
    db.pins.animals.forEach(id=> chips.appendChild(chipFor(getAnimal(id)?.name||id, ()=>unpin('animal',id))));
    db.pins.recipes.forEach(id=> chips.appendChild(chipFor(getRecipe(id)?.name||id, ()=>unpin('recipe',id))));

    // Suggestions
    const craftable = computeCraftable();
    const top = [...craftable.filter(c=>c.missing.length===0), ...craftable].slice(0,3);
    const box = qs('#homeSuggestions');
    box.innerHTML = '';
    top.forEach(c => box.appendChild(renderSuggestion(c)));
  }

  function chipFor(label, onx){
    const d=document.createElement('button'); d.className='chip'; d.innerHTML=label+' ‚úï'; d.onclick=()=>{onx();}; return d;
  }

  function renderFilters(){
    const sel = qs('#fltRegion');
    sel.innerHTML = '<option value="">All Regions</option>' + db.regions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
  }

  function renderAnimals(){
    const q = (qs('#qHunt').value||'').toLowerCase();
    const r = qs('#fltRegion').value || '';
    const t = qs('#fltTime').value || '';
    const list = qs('#listAnimals'); list.innerHTML = '';
    db.animals
      .filter(a=>!q || a.name.toLowerCase().includes(q) || a.family.toLowerCase().includes(q))
      .filter(a=>!r || a.regionIds.includes(r))
      .filter(a=>!t || (a.activeTimes||[]).includes(t))
      .forEach(a=> list.appendChild(renderAnimal(a)) );
  }

  function renderAnimal(a){
    const rule = db.huntRules.find(h=>h.animalId===a.id);
    const div = document.createElement('div'); div.className='item';
    const regs = a.regionIds.map(id=> db.regions.find(r=>r.id===id)?.name).join(', ');
    div.innerHTML = `
      <div class="hdr">
        <div>
          <div class="title">${a.name}</div>
          <div class="sub">Family: ${a.family} ‚Ä¢ Regions: ${regs}</div>
        </div>
        <div class="row" style="gap:6px">
          <button class="small" data-pin="${a.id}">Pin</button>
          <span class="tag">Perfect Pelt</span>
        </div>
      </div>
      <div class="sub" style="margin-top:6px">${a.habitatNotes}</div>
      <div class="row" style="margin-top:8px; gap:6px">
        <div class="badge">Weapon: ${rule?.weapon||'‚Äî'}</div>
        <div class="badge">Ammo: ${rule?.ammo||'‚Äî'}</div>
        <div class="badge">Shots: ${rule?.shots||'‚Äî'}</div>
      </div>
      <div class="row right" style="margin-top:8px">
        <button class="primary small" data-log="${a.id}">Log Perfect</button>
      </div>
    `;
    div.querySelector('[data-log]')?.addEventListener('click', ()=> logKillById(a.id,3));
    div.querySelector('[data-pin]')?.addEventListener('click', ()=> pin('animal', a.id));
    return div;
  }

  function renderRecipes(){
    const listAll = qs('#listRecipes');
    const listNow = qs('#listCraftable');
    listAll.innerHTML=''; listNow.innerHTML='';
    const craftable = computeCraftable();
    craftable.forEach(c=> listNow.appendChild(renderRecipe(c.recipe, c.missing)) );
    db.recipes.forEach(r=> listAll.appendChild(renderRecipe(r)) );
  }

  function renderRecipe(r, missing){
    const div=document.createElement('div');
    div.className='item';
    const miss = missing && missing.length? ` ‚Ä¢ Missing: ${missing.map(m=>m.item+`(${m.qty})`).join(', ')}`:'';
    div.innerHTML = `
      <div class="hdr">
        <div>
          <div class="title">${r.name}</div>
          <div class="sub">${r.station}${r.vendorType?` ‚Ä¢ ${r.vendorType}`:''}${miss}</div>
        </div>
        <div class="row" style="gap:6px">
          <button class="small" data-pin-recipe="${r.id}">Pin</button>
          <button class="small" data-craft-id="${r.id}">Craft</button>
        </div>
      </div>
      <div class="sub" style="margin-top:6px">Inputs: ${r.inputs.map(i=>`${i.item}√ó${i.qty}`).join(', ')} ‚Ä¢ Outputs: ${r.outputs.map(o=>`${o.item}√ó${o.qty}`).join(', ')}</div>
    `;
    div.querySelector('[data-craft-id]').onclick = ()=> craft(r.id);
    div.querySelector('[data-pin-recipe]').onclick = ()=> pin('recipe', r.id);
    return div;
  }

  function renderChallenges(){
    const list = qs('#listChallenges'); list.innerHTML='';
    db.challenges.forEach(c=>{
      const div = document.createElement('div'); div.className='item';
      const done = c.done? '‚úÖ Completed':'‚≠ï Not done';
      div.innerHTML = `
        <div class="hdr">
          <div>
            <div class="title">${c.category} ‚Äì Tier ${c.tier}</div>
            <div class="sub">${c.description}</div>
          </div>
          <button class="small" data-chal="${c.id}">${done}</button>
        </div>`;
      div.querySelector('button').onclick = ()=>{ c.done=!c.done; vibrate(20); save(); };
      list.appendChild(div);
    });
  }

  function renderChecklist(){
    const list = qs('#listChecklist'); list.innerHTML='';
    db.checklist.forEach(c=>{
      const div = document.createElement('div'); div.className='item';
      div.innerHTML = `
        <div class="hdr">
          <div class="title">${c.label}</div>
          <button class="small" data-cl="${c.id}">${c.done?'‚úÖ Done':'Mark Done'}</button>
        </div>`;
      div.querySelector('button').onclick = ()=>{ c.done=!c.done; vibrate(20); save(); };
      list.appendChild(div);
    });
  }

  function renderProfile(){
    qs('#ownerName').value = db.profile.ownerName || '';
    qs('#ownerNameInline').textContent = db.profile.ownerName || 'Alley';
    qs('#cats').value = (db.profile.cats||[]).join(', ');
    qs('#theme').value = db.profile.theme || 'green';
    qs('#spoilers').checked = !!db.settings.spoilers;
    document.documentElement.setAttribute('data-theme', db.profile.theme || 'green');

    const pins = qs('#pins'); pins.innerHTML='';
    db.pins.animals.forEach(id=> pins.appendChild(chipFor(getAnimal(id)?.name||id, ()=>unpin('animal',id))));
    db.pins.recipes.forEach(id=> pins.appendChild(chipFor(getRecipe(id)?.name||id, ()=>unpin('recipe',id))));
  }

  function renderAll(){
    renderHome(); renderFilters(); renderAnimals(); renderRecipes(); renderChallenges(); renderChecklist(); renderProfile();
  }

  // ======== Core logic ========
  function getAnimal(id){ return db.animals.find(a=>a.id===id); }
  function getRecipe(id){ return db.recipes.find(r=>r.id===id); }

  function logKillById(animalId, quality){
    const a = getAnimal(animalId); if(!a) return alert('Animal not found');
    const pelts = db.inventory.pelts;
    const row = pelts.find(p=>p.animalId===animalId && p.quality===quality);
    if(row) row.qty += 1; else pelts.push({animalId, quality, qty:1});
    db.events.push({id:crypto.randomUUID(), type:'kill', at:Date.now(), payload:{animalId, quality}});
    vibrate(20); save();
  }

  function logKillByName(name, quality){
    const a = db.animals.find(x=>x.name.toLowerCase()===name.toLowerCase());
    if(!a) return alert('No exact match for '+name);
    logKillById(a.id, quality);
  }

  function computeCraftable(){
    const have = new Map();
    db.inventory.pelts.forEach(p=>{
      const a = getAnimal(p.animalId)?.name || p.animalId;
      const label = (p.quality===3? 'Perfect ':'') + (a.includes('Pelt')? a : `${a.includes('Hide')?a:a+' Pelt'}`);
      have.set(label, (have.get(label)||0)+p.qty);
    });
    db.inventory.materials.forEach(m=> have.set(m.item, (have.get(m.item)||0)+m.qty));
    return db.recipes.map(r=>{
      const missing = r.inputs.map(i=>({item:i.item, qty: Math.max(0, i.qty - (have.get(i.item)||0))}))
                              .filter(m=>m.qty>0);
      return { recipe:r, missing };
    }).sort((a,b)=> a.missing.length - b.missing.length);
  }

  function craft(recipeId){
    const rec = getRecipe(recipeId); if(!rec) return;
    const craftable = computeCraftable().find(c=>c.recipe.id===recipeId);
    if(craftable.missing.length){ alert('Missing: '+craftable.missing.map(m=>m.item+`(${m.qty})`).join(', ')); return; }
    // consume inputs
    rec.inputs.forEach(i=>{
      let remaining = i.qty;
      const nameFromPelt = (p)=>{
        const an = getAnimal(p.animalId)?.name || ''; return (p.quality===3? 'Perfect '+an+' Pelt' : an+' Pelt');
      };
      for(const p of [...db.inventory.pelts]){
        if(nameFromPelt(p)===i.item && remaining>0){
          const take = Math.min(p.qty, remaining); p.qty -= take; remaining -= take; if(p.qty<=0) db.inventory.pelts = db.inventory.pelts.filter(x=>x!==p);
        }
      }
      if(remaining>0){
        const mat = db.inventory.materials.find(m=>m.item===i.item);
        if(mat){ const take = Math.min(mat.qty, remaining); mat.qty -= take; remaining -= take; if(mat.qty<=0) db.inventory.materials = db.inventory.materials.filter(x=>x!==mat); }
      }
    });
    rec.outputs.forEach(o=>{
      const row = db.inventory.materials.find(m=>m.item===o.item);
      if(row) row.qty += o.qty; else db.inventory.materials.push({item:o.item, qty:o.qty});
    });
    db.events.push({id:crypto.randomUUID(), type:'craft', at:Date.now(), payload:{recipeId}});
    vibrate(30); save(); alert('Crafted: '+rec.name);
  }

  function pin(kind, id){
    const set = (kind==='animal')? db.pins.animals : db.pins.recipes;
    if(!set.includes(id)) set.push(id);
    save();
  }
  function unpin(kind, id){
    const set = (kind==='animal')? db.pins.animals : db.pins.recipes;
    const i = set.indexOf(id); if(i>-1) set.splice(i,1); save();
  }

  function detailForRecipe(r){
    const v = r.vendorType? (' at '+r.vendorType) : '';
    return `${r.name}${v}
Inputs: ${r.inputs.map(i=>`${i.item}√ó${i.qty}`).join(', ')}
Outputs: ${r.outputs.map(o=>`${o.item}√ó${o.qty}`).join(', ')}`;
  }

  // ======== Export/Import/Share ========
  qs('#btnExport').onclick = ()=>{
    const payload = JSON.stringify(db, null, 2);
    const blob = new Blob([payload], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rdr2-companion-backup.json'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 1000);
  };

  qs('#btnImport').onclick = ()=>{
    const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'application/json';
    inp.onchange = e => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = () => { try { const j = JSON.parse(r.result); Object.assign(db, j); save(); } catch(err){ alert('Invalid file'); } }; r.readAsText(f); };
    inp.click();
  };

  qs('#btnShare').onclick = async()=>{
    const url = location.href; const text = `RDR2 Companion for ${db.profile.ownerName}: ${url}`;
    if(navigator.share){ try{ await navigator.share({title:'RDR2 Companion', text, url}); }catch(e){} }
    else { navigator.clipboard?.writeText(url); alert('Link copied to clipboard'); }
  };

  // ======== Events ========
  qs('#btnLogKill').onclick = ()=>{
    const name = qs('#logAnimal').value.trim();
    const q = parseInt(qs('#logQuality').value,10);
    if(!name) return alert('Enter an animal name');
    logKillByName(name, q); qs('#logAnimal').value = '';
  };
  qs('#btnQuickMat').onclick = ()=>{
    const item = prompt('Material name (e.g., Silver Chain Bracelet)'); if(!item) return;
    const qty = parseInt(prompt('Quantity'),10)||1;
    const row = db.inventory.materials.find(m=>m.item===item); if(row) row.qty+=qty; else db.inventory.materials.push({item, qty});
    save();
  };

  qs('#qHunt').addEventListener('input', renderAnimals);
  qs('#fltRegion').addEventListener('change', renderAnimals);
  qs('#fltTime').addEventListener('change', renderAnimals);

  // Profile save
  qs('#saveProfile').onclick = ()=>{
    db.profile.ownerName = qs('#ownerName').value.trim() || 'Alley';
    db.profile.cats = (qs('#cats').value||'').split(',').map(s=>s.trim()).filter(Boolean);
    db.profile.theme = qs('#theme').value || 'green';
    db.settings.spoilers = qs('#spoilers').checked;
    document.documentElement.setAttribute('data-theme', db.profile.theme);
    vibrate(30); save();
  };

  // Clear pins
  qs('#clearPins').onclick = ()=>{ db.pins.animals=[]; db.pins.recipes=[]; save(); };

  // Install hint visibility
  (function(){
    const hint = qs('#installHint');
    const iOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if(iOS) hint.textContent = 'Share ‚Üí Add to Home Screen';
  })();

  // Boot
  document.documentElement.setAttribute('data-theme', db.profile?.theme || 'green');
  renderTabs();
  renderAll();
  </script>
</body>
</html>
