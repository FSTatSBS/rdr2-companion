<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Alley‚Äôs RDR2 Companion ‚Äî Ultimate (v2)</title>
  <meta name="description" content="Second-screen RDR2 companion for Alley: hunting, crafting, challenges, map, pins, personalization. Single-file, offline-first, export/import, share.">
  <style>
    :root { --bg:#0a0f16; --panel:#0f172a; --muted:#93a4c2; --text:#e8f0ff; --accent:#22c55e; --accent-2:#a78bfa; --border:#1e2c46; --card:#0b1222; --danger:#ef4444; }
    html[data-theme="gold"] { --accent:#d4a72c; --accent-2:#8b5cf6; }
    html[data-theme="rose"] { --accent:#e11d48; --accent-2:#22d3ee; }
    html[data-theme="sky"]  { --accent:#0ea5e9; --accent-2:#f97316; }
    * { box-sizing: border-box; }
    html, body { margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { position:sticky; top:0; z-index:5; backdrop-filter:saturate(160%) blur(8px); background:rgba(10,15,22,.85); border-bottom:1px solid var(--border); }
    header .bar { display:flex; align-items:center; gap:8px; padding: env(safe-area-inset-top) 12px 12px; }
    h1 { font-size:18px; margin:0; letter-spacing:.2px; }
    .pill { padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); font-size:12px;}
    .tabs { display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; padding:6px 12px 10px; }
    .tab { padding:8px 10px; border-radius:12px; background:var(--panel); border:1px solid var(--border); color:var(--muted); font-size:12px; text-align:center; }
    .tab.active { background:linear-gradient(180deg, #18233a, #0f172a); color:#fff; border-color:#2a3f66; }
    main { padding: 10px 12px 100px; }
    .grid { display:grid; gap:10px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:18px; padding:12px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.right{ justify-content:flex-end; }
    .title { font-weight:800; font-size:16px; }
    .sub { font-size:12px; color:var(--muted); }
    .list { display:grid; gap:8px; }
    .item { background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px; }
    .item .hdr { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); }
    .tag { font-size:11px; padding:4px 8px; border-radius:999px; background:#0d2231; border:1px solid #1d3650; }
    input, select, button, textarea { font:inherit; color:inherit; }
    input, select, textarea { background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:10px; }
    button { background:var(--panel); border:1px solid var(--border); padding:10px 12px; border-radius:12px; cursor:pointer; }
    button.primary { background:linear-gradient(180deg, color-mix(in hsl, var(--accent) 75%, black), color-mix(in hsl, var(--accent) 55%, black)); border-color:var(--accent); color:#fff; }
    button.ghost { background:transparent; border-color:var(--border); }
    button.small { font-size:12px; padding:6px 8px; border-radius:10px; }
    .kpi { display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
    .k { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:10px; text-align:center; }
    .k .v { font-size:18px; font-weight:800; }
    .k .l { font-size:11px; color:var(--muted); }
    .foot { position:fixed; bottom:0; left:0; right:0; backdrop-filter:saturate(160%) blur(8px); background:rgba(10,15,22,.9); border-top:1px solid var(--border); padding:10px 12px calc(10px + env(safe-area-inset-bottom)); display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .foot button { border-radius:12px; padding:10px; }
    .hide { display:none !important; }
    .progress-ring { width:90px; height:90px; border-radius:50%; background: conic-gradient(var(--accent) var(--p,0%), #22324a 0%); display:grid; place-items:center; font-weight:800; }
    .avatar { width:36px; height:36px; border-radius:50%; display:grid; place-items:center; background: color-mix(in hsl, var(--accent) 25%, black); border:1px solid var(--border); }
    .chip { padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#0d1a27; color:#fff; font-size:12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    /* Map */
    #mapWrap, #huntMapWrap { background:#0b1324; border:1px solid var(--border); border-radius:14px; overflow:hidden; }
    #map, #huntMap { width:100%; height:300px; background: radial-gradient(60% 60% at 50% 50%, #0d1b33, #0a1324 70%); }
    svg text { fill:#9eb3d8; font-size:10px; }
    .dot { r:6; fill:var(--accent); stroke:#0b1222; stroke-width:2; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="avatar">üê±</div>
      <div class="pill">Alley‚Äôs Companion</div>
      <h1>RDR2 ‚Äî Hunt ‚Ä¢ Craft ‚Ä¢ Map ‚Ä¢ Complete</h1>
      <div style="flex:1"></div>
      <button id="btnExport" title="Export data">Export</button>
      <button id="btnImport" title="Import data">Import</button>
      <button id="btnShare" class="ghost">Share</button>
      <button id="btnReset" class="ghost" title="Reset data">Reset</button>
      <button id="btnUndo" class="ghost" title="Undo last">Undo</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="home">Home</div>
      <div class="tab" data-tab="hunt">Hunt</div>
      <div class="tab" data-tab="craft">Craft</div>
      <div class="tab" data-tab="maptab">Map</div>
      <div class="tab" data-tab="challenges">Challenges</div>
      <div class="tab" data-tab="complete">100%</div>
      <div class="tab" data-tab="profile">Profile</div>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="grid">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">Tonight's Targets</div>
            <div class="sub">Pins & suggestions for <span id="ownerNameInline">Alley</span></div>
            <div id="pinnedChips" class="row" style="margin-top:6px"></div>
          </div>
          <div class="progress-ring" id="pctComplete">0%</div>
        </div>
        <div id="homeSuggestions" class="list" style="margin-top:8px"></div>
      </div>

      <div class="card kpi">
        <div class="k"><div class="v" id="kPelts">0</div><div class="l">Perfect Pelts</div></div>
        <div class="k"><div class="v" id="kCraft">0</div><div class="l">Crafted Items</div></div>
        <div class="k"><div class="v" id="kCheck">0</div><div class="l">Checklist Done</div></div>
        <div class="k"><div class="v" id="kPins">0</div><div class="l">Pinned</div></div>
      </div>

      <div class="card">
        <div class="row"><div class="title">Quick Log</div><span class="sub">Pick animal & quality</span></div>
        <div class="row" style="gap:8px; margin-top:8px">
          <select id="logAnimalSelect" style="flex:1"></select>
          <select id="logQuality">
            <option value="3">Perfect ‚òÖ‚òÖ‚òÖ</option>
            <option value="2">Good ‚òÖ‚òÖ</option>
            <option value="1">Poor ‚òÖ</option>
          </select>
          <button class="primary" id="btnLogKill">Log</button>
        </div>
        <div class="row right" style="margin-top:8px">
          <button class="ghost" id="btnQuickMat">+ Material</button>
        </div>
      </div>
    </section>

    <!-- HUNT -->
    <section id="hunt" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Animal Index</div><span class="sub">Filter by region / time / text</span></div>
        <div class="row" style="gap:8px; margin-top:8px">
          <input id="qHunt" placeholder="Search (name or family)" style="flex:1" />
          <select id="fltRegion"></select>
          <select id="fltTime">
            <option value="">Any Time</option>
            <option value="day">Day</option>
            <option value="night">Night</option>
          </select>
        </div>
      </div>
      <!-- Inline mini map for Hunt tab -->
      <div class="card" id="huntMapWrap">
        <div class="row" style="justify-content:space-between">
          <div class="title">Mini Map (filters above)</div>
          <div class="sub">Tap markers for perfect-pelt tips</div>
        </div>
        <div id="huntMap" class="mono"></div>
      </div>
      <div id="listAnimals" class="list"></div>
    </section>

    <!-- CRAFT -->
    <section id="craft" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Crafting</div><span class="sub">Craftable now appears first</span></div>
      </div>
      <div id="listCraftable" class="list"></div>
      <div class="card"><div class="title">All Recipes</div></div>
      <div id="listRecipes" class="list"></div>
    </section>

    <!-- MAP -->
    <section id="maptab" class="grid hide">
      <div class="card" id="mapWrap">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="title">Hunting Map</div>
            <div class="sub">Filter and tap markers</div>
          </div>
          <div class="row">
            <select id="mapFRegion"></select>
            <select id="mapFTime">
              <option value="">Any</option>
              <option value="day">Day</option>
              <option value="night">Night</option>
            </select>
            <input id="mapQ" placeholder="Animal/family" style="width:140px" />
          </div>
        </div>
        <div id="map" class="mono"></div>
      </div>
      <div id="mapList" class="list"></div>
    </section>

    <!-- CHALLENGES -->
    <section id="challenges" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">Challenges</div><span class="sub">Pin favorites ‚Ä¢ Tap to complete</span></div>
      </div>
      <div id="listChallenges" class="list"></div>
    </section>

    <!-- 100% -->
    <section id="complete" class="grid hide">
      <div class="card">
        <div class="row"><div class="title">100% Checklist</div><span class="sub">Major milestones</span></div>
      </div>
      <div id="listChecklist" class="list"></div>
    </section>

    <!-- PROFILE / SETTINGS -->
    <section id="profile" class="grid hide">
      <div class="card">
        <div class="row" style="justify-content:space-between;gap:12px">
          <div class="row" style="gap:10px">
            <div class="avatar">üê±</div>
            <div>
              <div class="title">Profile</div>
              <div class="sub">Make it yours, Alley</div>
            </div>
          </div>
          <div class="chip" id="installHint">Add to Home Screen ‚ûú</div>
        </div>
        <div class="row" style="margin-top:10px; gap:8px">
          <input id="ownerName" placeholder="Owner name" style="flex:1" />
          <select id="theme">
            <option value="green">Green</option>
            <option value="gold">Gold</option>
            <option value="rose">Rose</option>
            <option value="sky">Sky</option>
          </select>
        </div>
        <div class="row" style="margin-top:8px; gap:8px">
          <input id="cats" placeholder="Cats (comma separated)" style="flex:1" />
        </div>
        <div class="row" style="margin-top:8px; gap:8px">
          <label class="sub"><input type="checkbox" id="spoilers"/> Show spoilers</label>
        </div>
        <div class="row" style="margin-top:8px; gap:8px">
          <button id="btnBackupToText" class="ghost">Copy backup JSON</button>
          <button id="btnRestoreFromText" class="ghost">Paste backup JSON</button>
        </div>
        <div class="row right" style="margin-top:8px">
          <button class="primary" id="saveProfile">Save</button>
        </div>
      </div>

      <div class="card">
        <div class="title">Pinned items</div>
        <div class="sub">Animals ‚Ä¢ Recipes ‚Ä¢ Challenges</div>
        <div id="pins" class="row" style="margin-top:8px;gap:6px;flex-wrap:wrap"></div>
        <div class="row right" style="margin-top:8px">
          <button class="ghost" id="clearPins">Clear Pins</button>
        </div>
      </div>
    </section>
  </main>

  <div class="foot">
    <button class="tab active" data-tab="home">Home</button>
    <button class="tab" data-tab="hunt">Hunt</button>
    <button class="tab" data-tab="craft">Craft</button>
    <button class="tab" data-tab="maptab">Map</button>
    <button class="tab" data-tab="challenges">Challenges</button>
    <button class="tab" data-tab="complete">100%</button>
    <button class="tab" data-tab="profile">Profile</button>
  </div>

  <script>
  const DBKEY='rdr2_companion_ultra_alley_v2';
  let db = JSON.parse(localStorage.getItem(DBKEY) || 'null') || seed();
  let undoStack=[];
  function commit(){ localStorage.setItem(DBKEY, JSON.stringify(db)); }
  function save(){ commit(); renderAll(); }
  function pushUndo(){ undoStack.push(JSON.stringify(db)); if(undoStack.length>20) undoStack.shift(); }
  function undo(){ if(!undoStack.length) return alert('Nothing to undo'); db=JSON.parse(undoStack.pop()); save(); }

  function seed(){
    const regions=[
      {id:'new_hanover', name:'New Hanover', states:['Heartlands','Grizzlies East']},
      {id:'west_elizabeth', name:'West Elizabeth', states:['Big Valley','Tall Trees']},
      {id:'lemoyne', name:'Lemoyne', states:['Bayou Nwa','Scarlett Meadows']},
      {id:'ambarino', name:'Ambarino', states:['Grizzlies West','Cotorra Springs']},
      {id:'new_austin', name:'New Austin', states:['Cholla Springs','Rio Bravo','Hennigan‚Äôs Stead']},
    ];
    const animals=[
      {id:'whitetail_buck', name:'Whitetail Buck', family:'deer', regions:['new_hanover','west_elizabeth'], habitat:'Open woodlands, meadows', times:['day','night']},
      {id:'whitetail_doe', name:'Whitetail Doe', family:'deer', regions:['new_hanover','west_elizabeth'], habitat:'Small herds; skittish', times:['day','night']},
      {id:'pronghorn', name:'Pronghorn', family:'antelope', regions:['new_hanover','west_elizabeth','new_austin'], habitat:'Heartlands & Cholla', times:['day']},
      {id:'american_bison', name:'American Bison', family:'bison', regions:['west_elizabeth','new_hanover'], habitat:'Big Valley grasslands', times:['day']},
      {id:'elk', name:'Rocky Mountain Elk', family:'elk', regions:['ambarino','west_elizabeth'], habitat:'Grizzlies forests', times:['day','night']},
      {id:'moose', name:'Western Moose', family:'moose', regions:['ambarino','new_hanover'], habitat:'Lakes & marsh edges', times:['day']},
      {id:'bighorn', name:'Desert Bighorn Sheep', family:'sheep', regions:['new_austin','west_elizabeth'], habitat:'Rocky slopes', times:['day']},
      {id:'wolf', name:'Gray Wolf', family:'wolf', regions:['ambarino','west_elizabeth'], habitat:'Packs; howls at dusk', times:['night','day']},
      {id:'cougar', name:'Cougar', family:'cougar', regions:['west_elizabeth','new_austin'], habitat:'Solitary ambusher', times:['night']},
      {id:'bear_grizzly', name:'Grizzly Bear', family:'bear', regions:['ambarino','west_elizabeth'], habitat:'Aggressive', times:['day']},
      {id:'black_bear', name:'American Black Bear', family:'bear', regions:['west_elizabeth','new_hanover'], habitat:'Forested hills', times:['day']},
      {id:'fox', name:'American Red Fox', family:'birdless_mammal', regions:['new_hanover','west_elizabeth','lemoyne'], habitat:'Fields & edges', times:['night','day']},
      {id:'coyote', name:'North American Coyote', family:'birdless_mammal', regions:['new_austin','new_hanover','west_elizabeth'], habitat:'Common; yips', times:['night','day']},
      {id:'beaver', name:'North American Beaver', family:'water_mammal', regions:['west_elizabeth','ambarino','new_hanover'], habitat:'Rivers & ponds', times:['day']},
      {id:'badger', name:'American Badger', family:'birdless_mammal', regions:['west_elizabeth','new_austin'], habitat:'Open country burrows', times:['day','night']},
      {id:'boar', name:'Wild Boar', family:'birdless_mammal', regions:['lemoyne','new_hanover'], habitat:'Swamps & thickets', times:['night','day']},
      {id:'raccoon', name:'Raccoon', family:'birdless_mammal', regions:['lemoyne','new_hanover','west_elizabeth'], habitat:'Nocturnal scavenger', times:['night']},
      {id:'opossum', name:'Virginia Opossum', family:'birdless_mammal', regions:['lemoyne','new_hanover'], habitat:'Plays dead', times:['night']},
      {id:'muskrat', name:'Common Muskrat', family:'water_mammal', regions:['lemoyne','new_hanover'], habitat:'Waterways', times:['day','night']},
      {id:'rabbit', name:'Black-tailed Jackrabbit', family:'birdless_mammal', regions:['lemoyne','new_hanover','west_elizabeth','new_austin'], habitat:'Everywhere', times:['day','night']},
      {id:'squirrel', name:'Gray Squirrel', family:'birdless_mammal', regions:['new_hanover','west_elizabeth','lemoyne'], habitat:'Trees; skittish', times:['day']},
      {id:'turkey', name:'Eastern Wild Turkey', family:'bird', regions:['new_hanover','west_elizabeth','lemoyne'], habitat:'Forest floors', times:['day']},
      {id:'duck_mallard', name:'Mallard Duck', family:'bird', regions:['new_hanover','lemoyne'], habitat:'Ponds & shorelines', times:['day']},
      {id:'goose', name:'Canada Goose', family:'bird', regions:['new_hanover','west_elizabeth'], habitat:'Lakes & fields', times:['day']},
      {id:'heron', name:'Great Blue Heron', family:'bird', regions:['lemoyne'], habitat:'Bayou shallows', times:['day']},
      {id:'egret', name:'Little Egret', family:'bird', regions:['lemoyne'], habitat:'Bayou plume bird', times:['day']},
      {id:'oriole', name:'Baltimore Oriole', family:'bird', regions:['lemoyne','new_hanover'], habitat:'Perches; small target', times:['day']},
      {id:'alligator', name:'American Alligator', family:'reptile_water', regions:['lemoyne'], habitat:'Bayou marshes', times:['night','day']},
      {id:'iguana', name:'Green Iguana', family:'reptile_land', regions:['new_austin'], habitat:'Islands & rocks', times:['day']},
      {id:'snake', name:'Western Rattlesnake', family:'reptile_land', regions:['new_austin'], habitat:'Arid scrub', times:['day','night']},
    ];
    const huntRules=[
      {animalId:'whitetail_buck', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head/heart'},
      {animalId:'whitetail_doe', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head/heart'},
      {animalId:'pronghorn', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'american_bison', weapon:'Springfield/Bolt', ammo:'Express', shots:'1√ó head'},
      {animalId:'elk', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head/heart'},
      {animalId:'moose', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'bighorn', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'wolf', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'cougar', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'bear_grizzly', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'black_bear', weapon:'Bolt Action Rifle', ammo:'Express', shots:'1√ó head'},
      {animalId:'fox', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'coyote', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'beaver', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'badger', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'boar', weapon:'Bow', ammo:'Improved Arrow', shots:'1√ó head'},
      {animalId:'raccoon', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'opossum', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'muskrat', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'rabbit', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'squirrel', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'turkey', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'duck_mallard', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'goose', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'heron', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'egret', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'oriole', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'alligator', weapon:'Rolling Block', ammo:'Express', shots:'1√ó brain'},
      {animalId:'iguana', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
      {animalId:'snake', weapon:'Varmint Rifle', ammo:'Regular', shots:'1√ó head'},
    ];

    // Recipe inputs match computed pelts: "Perfect <Animal Name> Pelt"
    const recipes=[
      {id:'trapper_bear_hat', name:'Grizzly Mountain Hat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Legendary Bear Pelt', qty:1}], outputs:[{item:'Grizzly Mountain Hat', qty:1}]},
      {id:'trapper_bison_coat', name:'Bison Coat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect American Bison Pelt', qty:2}], outputs:[{item:'Bison Coat', qty:1}]},
      {id:'trapper_deer_gloves', name:'Deerskin Gloves', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect Whitetail Buck Pelt', qty:1}], outputs:[{item:'Deerskin Gloves', qty:1}]},
      {id:'trapper_elk_gloves', name:'Elk Range Gloves', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect Rocky Mountain Elk Pelt', qty:1}], outputs:[{item:'Elk Range Gloves', qty:1}]},
      {id:'trapper_moose_coat', name:'Moose Hunting Coat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect Western Moose Pelt', qty:1}], outputs:[{item:'Moose Hunting Coat', qty:1}]},
      {id:'trapper_cougar_coat', name:'Cougar Cutaway Coat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect Cougar Pelt', qty:1}], outputs:[{item:'Cougar Cutaway Coat', qty:1}]},
      {id:'trapper_fox_gloves', name:'Fox Range Gloves', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect American Red Fox Pelt', qty:1}], outputs:[{item:'Fox Range Gloves', qty:1}]},
      {id:'trapper_beaver_hat', name:'Beaver Flop Hat', station:'Trapper', vendorType:'Trapper', inputs:[{item:'Perfect North American Beaver Pelt', qty:1}], outputs:[{item:'Beaver Flop Hat', qty:1}]},
      // Satchels (use specific pelts that user can actually log)
      {id:'satchel_tonics', name:'Tonics Satchel', station:'Camp', vendorType:'Pearson', inputs:[
        {item:'Perfect Whitetail Buck Pelt', qty:1},{item:'Perfect Rocky Mountain Elk Pelt', qty:1},{item:'Perfect North American Beaver Pelt', qty:1}
      ], outputs:[{item:'Tonics Satchel', qty:1}], requires:['Leather Working Tools']},
      {id:'satchel_materials', name:'Materials Satchel', station:'Camp', vendorType:'Pearson', inputs:[
        {item:'Perfect Whitetail Doe Pelt', qty:1},{item:'Perfect Wild Boar Pelt', qty:1},{item:'Perfect Green Iguana Pelt', qty:1}
      ], outputs:[{item:'Materials Satchel', qty:1}], requires:['Leather Working Tools']},
      // Fences (legendary parts are tracked as materials by name)
      {id:'fence_trinket_bear', name:'Bear Claw Talisman', station:'Fence', vendorType:'Fence', inputs:[{item:'Legendary Bear Claw', qty:1},{item:'Silver Chain Bracelet', qty:1},{item:'Quartz Chunk', qty:1}], outputs:[{item:'Bear Claw Talisman', qty:1}]},
      {id:'fence_trinket_buck', name:'Buck Antler Trinket', station:'Fence', vendorType:'Fence', inputs:[{item:'Legendary Buck Antler', qty:1},{item:'Abalone Shell Fragment', qty:1}], outputs:[{item:'Buck Antler Trinket', qty:1}]},
    ];

    const challenges=[
      {id:'survivalist_1', category:'Survivalist', tier:1, description:'Catch 3 Bluegill', requirements:['3√ó Bluegill caught']},
      {id:'survivalist_2', category:'Survivalist', tier:2, description:'Craft 5 items at a campfire', requirements:['5√ó crafted at campfire']},
      {id:'master_hunter_1', category:'Master Hunter', tier:1, description:'Skin 3 deer', requirements:['3√ó Deer skinned']},
      {id:'master_hunter_2', category:'Master Hunter', tier:2, description:'Collect 3 perfect pelts from coyotes or foxes', requirements:['3√ó Perfect small predator pelts']},
      {id:'sharpshooter_1', category:'Sharpshooter', tier:1, description:'Kill 3 flying birds', requirements:['3√ó birds shot mid-flight']},
      {id:'sharpshooter_2', category:'Sharpshooter', tier:2, description:'Kill 2 animals from a moving train', requirements:['2√ó animals from train']},
    ];

    const checklist=[
      {id:'cl_legendary_bear', kind:'collectible', label:'Legendary Bharati Bear ‚Äì Hunted', regionId:'ambarino'},
      {id:'cl_bear_trinket', kind:'trinket', label:'Bear Claw Talisman ‚Äì Crafted'},
      {id:'cl_satchel', kind:'satchel', label:'Satchel Upgrades Completed'},
      {id:'cl_legendary_buck', kind:'collectible', label:'Legendary Buck ‚Äì Hunted', regionId:'west_elizabeth'},
      {id:'cl_card_sets', kind:'collectible', label:'Cigarette Cards ‚Äì Any Set Completed'},
      {id:'cl_dinosaur_bones', kind:'collectible', label:'Dinosaur Bones ‚Äì 5 Found'},
      {id:'cl_rock_carvings', kind:'collectible', label:'Rock Carvings ‚Äì 5 Found'},
      {id:'cl_dreamcatchers', kind:'collectible', label:'Dreamcatchers ‚Äì 10 Found'},
    ];

    const vendors=[
      {id:'trapper_stdenis', type:'Trapper', name:'Trapper ‚Äî Saint Denis', regionId:'lemoyne'},
      {id:'trapper_bigvalley', type:'Trapper', name:'Trapper ‚Äî Big Valley', regionId:'west_elizabeth'},
      {id:'trapper_talltrees', type:'Trapper', name:'Trapper ‚Äî Tall Trees', regionId:'west_elizabeth'},
      {id:'fence_stdenis', type:'Fence', name:'Fence ‚Äî Saint Denis', regionId:'lemoyne'},
      {id:'fence_emerald', type:'Fence', name:'Fence ‚Äî Emerald Ranch', regionId:'new_hanover'},
      {id:'fence_vanhorne', type:'Fence', name:'Fence ‚Äî Van Horn', regionId:'new_hanover'},
      {id:'pearson_camp', type:'Pearson', name:'Pearson ‚Äî Camp', regionId:'new_hanover'},
    ];

    const inventory={ pelts:[], materials:[] };
    const events=[];
    const settings={ spoilers:false, preferredUnits:'imperial', showMap:true };
    const profile={ ownerName:'Alley', cats:['Mittens','Pumpkin'], theme:'green' };
    const pins={ animals:[], recipes:[], challenges:[] };

    return { regions, animals, huntRules, recipes, challenges, checklist, vendors, inventory, events, settings, profile, pins };
  }

  // Helpers
  const qs = s=>document.querySelector(s);
  const qsa = s=>Array.from(document.querySelectorAll(s));
  const vibrate = ms=> (navigator.vibrate? navigator.vibrate(ms): false);
  const getRegion=id=>db.regions.find(r=>r.id===id);
  const getAnimal=id=>db.animals.find(a=>a.id===id);
  const getRecipe=id=>db.recipes.find(r=>r.id===id);
  const getChallenge=id=>db.challenges.find(c=>c.id===id);
  function percent(n,d){ return d? Math.round((n/d)*100):0; }

  // Tabs
  function renderTabs(){
    qsa('.tab').forEach(t=>{
      t.onclick=()=>{
        qsa('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
        qsa('main section').forEach(sec=>sec.classList.add('hide'));
        qs('#'+t.dataset.tab).classList.remove('hide');
        if(t.dataset.tab==='maptab') drawMap('#map', '#mapList', '#mapQ', '#mapFRegion', '#mapFTime');
        if(t.dataset.tab==='hunt') drawMap('#huntMap', null, '#qHunt', '#fltRegion', '#fltTime');
      };
    });
  }

  // Home
  function renderHome(){
    qs('#ownerNameInline').textContent=db.profile.ownerName||'Alley';
    const perfect=db.inventory.pelts.filter(p=>p.quality===3).reduce((a,b)=>a+b.qty,0);
    const crafted=db.events.filter(e=>e.type==='craft').length;
    const done=db.checklist.filter(x=>x.done).length;
    qs('#kPelts').textContent=perfect; qs('#kCraft').textContent=crafted; qs('#kCheck').textContent=done;
    const pinCount=db.pins.animals.length+db.pins.recipes.length+db.pins.challenges.length; qs('#kPins').textContent=pinCount;
    const pct=percent(done, db.checklist.length); const ring=qs('#pctComplete'); ring.style.setProperty('--p', pct+'%'); ring.textContent=pct+'%';
    const chips=qs('#pinnedChips'); chips.innerHTML='';
    db.pins.animals.forEach(id=> chips.appendChild(chip(getAnimal(id)?.name||id, ()=>unpin('animal',id))));
    db.pins.recipes.forEach(id=> chips.appendChild(chip(getRecipe(id)?.name||id, ()=>unpin('recipe',id))));
    db.pins.challenges.forEach(id=> chips.appendChild(chip('Challenge: '+(getChallenge(id)?.category||'')+' T'+(getChallenge(id)?.tier||''), ()=>unpin('challenge',id))));

    const craftable=computeCraftable(); const top=[...craftable.filter(c=>c.missing.length===0), ...craftable].slice(0,3);
    const box=qs('#homeSuggestions'); box.innerHTML=''; top.forEach(c=> box.appendChild(suggestionCard(c)));
  }
  const chip=(label,onx)=>{ const b=document.createElement('button'); b.className='chip'; b.textContent=label+' ‚úï'; b.onclick=onx; return b; };
  function suggestionCard(c){
    const d=document.createElement('div'); d.className='item';
    d.innerHTML=`<div class="hdr"><div><div class="title">${c.recipe.name}</div><div class="sub">Craft at ${c.recipe.vendorType||c.recipe.station} ‚Ä¢ Missing: ${c.missing.map(m=>m.item+'('+m.qty+')').join(', ')||'None'}</div></div><div class="row"><button class="small" data-pin="${c.recipe.id}">Pin</button><button class="small" data-craft="${c.recipe.id}">Craft</button></div></div>`;
    d.querySelector('[data-craft]').onclick=()=>craft(c.recipe.id);
    d.querySelector('[data-pin]').onclick=()=>pin('recipe', c.recipe.id);
    return d;
  }

  // Filters + Index
  function populateFilters(){
    const regionOpts = '<option value="">All Regions</option>'+db.regions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
    qs('#fltRegion').innerHTML=regionOpts; qs('#mapFRegion').innerHTML='<option value="">Any</option>'+db.regions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
  }
  function renderAnimals(){
    const q=(qs('#qHunt').value||'').toLowerCase(); const r=qs('#fltRegion').value||''; const t=qs('#fltTime').value||'';
    const list=qs('#listAnimals'); list.innerHTML='';
    db.animals
      .filter(a=>!q || a.name.toLowerCase().includes(q) || a.family.toLowerCase().includes(q))
      .filter(a=>!r || a.regions.includes(r))
      .filter(a=>!t || (a.times||[]).includes(t))
      .sort((a,b)=> a.name.localeCompare(b.name))
      .forEach(a=> list.appendChild(animalCard(a)) );
    drawMap('#huntMap', null, '#qHunt', '#fltRegion', '#fltTime'); // keep mini map in sync
  }
  function animalCard(a){
    const rule=db.huntRules.find(h=>h.animalId===a.id); const div=document.createElement('div'); div.className='item';
    const regs=a.regions.map(id=> getRegion(id)?.name).join(', ');
    div.innerHTML=`<div class="hdr"><div><div class="title">${a.name}</div><div class="sub">Regions: ${regs}</div></div><div class="row" style="gap:6px"><button class="small" data-pin="${a.id}">Pin</button><button class="small" data-log="${a.id}">Log ‚òÖ‚òÖ‚òÖ</button></div></div><div class="sub" style="margin-top:6px">${a.habitat}</div><div class="row" style="margin-top:8px; gap:6px"><div class="badge">Weapon: ${rule?.weapon||'‚Äî'}</div><div class="badge">Ammo: ${rule?.ammo||'‚Äî'}</div><div class="badge">Shots: ${rule?.shots||'‚Äî'}</div></div>`;
    div.querySelector('[data-pin]').onclick=()=>pin('animal', a.id);
    div.querySelector('[data-log]').onclick=()=>logKillById(a.id,3);
    return div;
  }

  // Recipes
  function renderRecipes(){
    const listAll=qs('#listRecipes'); const listNow=qs('#listCraftable'); listAll.innerHTML=''; listNow.innerHTML='';
    const craftable=computeCraftable();
    craftable.forEach(c=> listNow.appendChild(recipeCard(c.recipe, c.missing)));
    db.recipes.slice().sort((a,b)=> a.name.localeCompare(b.name)).forEach(r=> listAll.appendChild(recipeCard(r)));
  }
  function recipeCard(r, missing){
    const d=document.createElement('div'); d.className='item';
    const miss=missing && missing.length? ' ‚Ä¢ Missing: '+missing.map(m=>m.item+'('+m.qty+')').join(', '):'';
    d.innerHTML=`<div class="hdr"><div><div class="title">${r.name}</div><div class="sub">${r.station}${r.vendorType? ' ‚Ä¢ '+r.vendorType:''}${miss}</div></div><div class="row" style="gap:6px"><button class="small" data-pin-recipe="${r.id}">Pin</button><button class="small" data-craft-id="${r.id}">Craft</button></div></div><div class="sub" style="margin-top:6px">Inputs: ${r.inputs.map(i=>`${i.item}√ó${i.qty}`).join(', ')} ‚Ä¢ Outputs: ${r.outputs.map(o=>`${o.item}√ó${o.qty}`).join(', ')}</div>`;
    d.querySelector('[data-pin-recipe]').onclick=()=>pin('recipe', r.id);
    d.querySelector('[data-craft-id]').onclick=()=>craft(r.id);
    return d;
  }

  // Challenges
  function renderChallenges(){
    const list=qs('#listChallenges'); list.innerHTML='';
    db.challenges.forEach(c=>{
      const d=document.createElement('div'); d.className='item'; const done=c.done?'‚úÖ Completed':'‚≠ï Not done'; const pinned=db.pins.challenges.includes(c.id);
      d.innerHTML=`<div class="hdr"><div><div class="title">${c.category} ‚Äî Tier ${c.tier}</div><div class="sub">${c.description}</div></div><div class="row"><button class="small" data-pin="${c.id}">${pinned?'Unpin':'Pin'}</button><button class="small" data-tgl="${c.id}">${done}</button></div></div>`;
      d.querySelector('[data-pin]').onclick=()=>togglePin('challenge', c.id);
      d.querySelector('[data-tgl]').onclick=()=>{ c.done=!c.done; pushUndo(); save(); };
      list.appendChild(d);
    });
  }

  // Checklist
  function renderChecklist(){
    const list=qs('#listChecklist'); list.innerHTML='';
    db.checklist.forEach(c=>{
      const d=document.createElement('div'); d.className='item';
      d.innerHTML=`<div class="hdr"><div class="title">${c.label}</div><button class="small" data-id="${c.id}">${c.done?'‚úÖ Done':'Mark Done'}</button></div>`;
      d.querySelector('button').onclick=()=>{ c.done=!c.done; pushUndo(); save(); };
      list.appendChild(d);
    });
  }

  // Profile
  function renderProfile(){
    qs('#ownerName').value=db.profile.ownerName||''; qs('#ownerNameInline').textContent=db.profile.ownerName||'Alley';
    qs('#cats').value=(db.profile.cats||[]).join(', '); qs('#theme').value=db.profile.theme||'green';
    qs('#spoilers').checked=!!db.settings.spoilers; document.documentElement.setAttribute('data-theme', db.profile.theme||'green');
    const pins=qs('#pins'); pins.innerHTML='';
    db.pins.animals.forEach(id=> pins.appendChild(chip(getAnimal(id)?.name||id, ()=>unpin('animal',id))));
    db.pins.recipes.forEach(id=> pins.appendChild(chip(getRecipe(id)?.name||id, ()=>unpin('recipe',id))));
    db.pins.challenges.forEach(id=> pins.appendChild(chip('Challenge: '+(getChallenge(id)?.category||'')+' T'+(getChallenge(id)?.tier||''), ()=>unpin('challenge',id))));
  }

  function renderAll(){ renderHome(); populateFilters(); renderAnimals(); renderRecipes(); renderChallenges(); renderChecklist(); renderProfile(); drawMap('#map', '#mapList', '#mapQ', '#mapFRegion', '#mapFTime'); populateQuickLogDropdown(); }

  // Pins
  function pin(kind,id){ const s=db.pins[kind+'s']; if(!s.includes(id)) s.push(id); pushUndo(); save(); }
  function togglePin(kind,id){ const s=db.pins[kind+'s']; const i=s.indexOf(id); if(i>-1) s.splice(i,1); else s.push(id); pushUndo(); save(); }
  function unpin(kind,id){ const s=db.pins[kind+'s']; const i=s.indexOf(id); if(i>-1) s.splice(i,1); pushUndo(); save(); }

  // Crafting / Inventory
  function computeCraftable(){
    const have=new Map();
    // Pelts -> "Perfect <Animal Name> Pelt" or "<Animal Name> Pelt"
    db.inventory.pelts.forEach(p=>{
      const an=getAnimal(p.animalId)?.name||p.animalId;
      const label=(p.quality===3? 'Perfect '+an+' Pelt': an+' Pelt');
      have.set(label,(have.get(label)||0)+p.qty);
    });
    db.inventory.materials.forEach(m=> have.set(m.item,(have.get(m.item)||0)+m.qty));
    return db.recipes.map(r=>{
      const missing=r.inputs.map(i=>({item:i.item, qty: Math.max(0, i.qty - (have.get(i.item)||0))})).filter(m=>m.qty>0);
      return {recipe:r, missing};
    }).sort((a,b)=> a.missing.length - b.missing.length);
  }
  function craft(id){
    const rec=getRecipe(id); if(!rec) return; const c=computeCraftable().find(x=>x.recipe.id===id);
    if(c.missing.length){ return alert('Missing: '+c.missing.map(m=>m.item+'('+m.qty+')').join(', ')); }
    pushUndo();
    rec.inputs.forEach(i=>{
      let need=i.qty;
      // consume pelts first
      for(const p of [...db.inventory.pelts]){
        const an=getAnimal(p.animalId)?.name||''; const label=(p.quality===3? 'Perfect '+an+' Pelt': an+' Pelt');
        if(label===i.item && need>0){ const take=Math.min(p.qty, need); p.qty-=take; need-=take; if(p.qty<=0) db.inventory.pelts=db.inventory.pelts.filter(x=>x!==p); }
      }
      if(need>0){ const m=db.inventory.materials.find(m=>m.item===i.item); if(m){ const take=Math.min(m.qty, need); m.qty-=take; need-=take; if(m.qty<=0) db.inventory.materials=db.inventory.materials.filter(x=>x!==m);} }
    });
    rec.outputs.forEach(o=>{ const row=db.inventory.materials.find(m=>m.item===o.item); if(row) row.qty+=o.qty; else db.inventory.materials.push({item:o.item, qty:o.qty}); });
    db.events.push({id:crypto.randomUUID(), type:'craft', at:Date.now(), payload:{recipeId:id}});
    vibrate(30); save(); alert('Crafted: '+rec.name);
  }

  // Logging
  function logKillById(animalId, quality){
    const a=getAnimal(animalId); if(!a) return alert('Animal not found');
    const row=db.inventory.pelts.find(p=>p.animalId===animalId && p.quality===quality);
    pushUndo(); if(row) row.qty+=1; else db.inventory.pelts.push({animalId,quality,qty:1});
    db.events.push({id:crypto.randomUUID(), type:'kill', at:Date.now(), payload:{animalId,quality}}); vibrate(20); save();
  }

  // Quick Log dropdown (grouped)
  function populateQuickLogDropdown(){
    const sel=qs('#logAnimalSelect'); sel.innerHTML='';
    const groups=[
      {label:'Land', test:a=>['bird','reptile_water','water_mammal'].indexOf(a.family)===-1},
      {label:'Water', test:a=>a.family==='reptile_water' || a.family==='water_mammal'},
      {label:'Air', test:a=>a.family==='bird'},
    ];
    groups.forEach(g=>{
      const og=document.createElement('optgroup'); og.label=g.label;
      db.animals.filter(g.test).sort((a,b)=>a.name.localeCompare(b.name)).forEach(a=>{
        const opt=document.createElement('option'); opt.value=a.id; opt.textContent=a.name; og.appendChild(opt);
      });
      sel.appendChild(og);
    });
  }

  // Map
  const regionPos={ ambarino:{x:120,y:60,w:140,h:80,label:'Ambarino'},
    new_hanover:{x:180,y:170,w:160,h:90,label:'New Hanover'},
    west_elizabeth:{x:60,y:160,w:110,h:100,label:'West Elizabeth'},
    lemoyne:{x:230,y:280,w:140,h:70,label:'Lemoyne'},
    new_austin:{x:60,y:280,w:150,h:80,label:'New Austin'} };
  function drawMap(containerSel, listSel, qSel, rSel, tSel){
    const map=qs(containerSel); if(!map) return; map.innerHTML='';
    const Q=(qs(qSel)?.value||'').toLowerCase(); const R=qs(rSel)?.value||''; const T=qs(tSel)?.value||'';
    const svgNS='http://www.w3.org/2000/svg'; const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox','0 0 420 370'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
    Object.entries(regionPos).forEach(([id,b])=>{ const g=document.createElementNS(svgNS,'g'); const r=document.createElementNS(svgNS,'rect'); r.setAttribute('x',b.x); r.setAttribute('y',b.y); r.setAttribute('rx',12); r.setAttribute('ry',12); r.setAttribute('width',b.w); r.setAttribute('height',b.h); r.setAttribute('fill','#0f1b33'); r.setAttribute('stroke','#1c2b4b'); r.setAttribute('stroke-width','1.5'); const t=document.createElementNS(svgNS,'text'); t.setAttribute('x',b.x+8); t.setAttribute('y',b.y+14); t.textContent=b.label; g.appendChild(r); g.appendChild(t); svg.appendChild(g); });
    db.animals.forEach(a=>{
      const rid=a.regions[0]; const b=regionPos[rid]; if(!b) return;
      if(R && !a.regions.includes(R)) return;
      if(T && !(a.times||[]).includes(T)) return;
      if(Q && !a.name.toLowerCase().includes(Q) && !a.family.toLowerCase().includes(Q)) return;
      const cx=b.x + b.w/2 + ((a.name.charCodeAt(0)%17)-8);
      const cy=b.y + b.h/2 + ((a.name.charCodeAt(1)%17)-8);
      const dot=document.createElementNS(svgNS,'circle'); dot.setAttribute('cx',cx); dot.setAttribute('cy',cy); dot.setAttribute('r',6); dot.setAttribute('class','dot');
      dot.onclick=()=> showAnimalPopup(a);
      svg.appendChild(dot);
    });
    map.appendChild(svg);
    if(listSel){
      const list=qs(listSel); list.innerHTML='';
      db.animals.filter(a=>!R || a.regions.includes(R)).filter(a=>!T || (a.times||[]).includes(T)).filter(a=>!Q || a.name.toLowerCase().includes(Q) || a.family.toLowerCase().includes(Q)).slice(0,30).forEach(a=> list.appendChild(animalCard(a)));
    }
  }
  function showAnimalPopup(a){
    const rule=db.huntRules.find(h=>h.animalId===a.id);
    alert(`${a.name}\nRegion(s): ${a.regions.map(id=>getRegion(id)?.name).join(', ')}\nTime: ${(a.times||[]).join('/')}\nPerfect: ${rule?.weapon||'‚Äî'} ‚Ä¢ ${rule?.ammo||'‚Äî'} ‚Ä¢ ${rule?.shots||'‚Äî'}`);
  }

  // Export/Import/Share/Reset/Undo
  qs('#btnExport').onclick=()=>{ const payload=JSON.stringify(db,null,2); const blob=new Blob([payload],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='rdr2-companion-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); };
  qs('#btnImport').onclick=()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ pushUndo(); db=JSON.parse(r.result); save(); }catch(err){ alert('Invalid file'); } }; r.readAsText(f); }; inp.click(); };
  qs('#btnShare').onclick=async()=>{ const url=location.href; const text=`RDR2 Companion for ${db.profile.ownerName}: ${url}`; if(navigator.share){ try{ await navigator.share({title:'RDR2 Companion', text, url}); }catch(e){} } else { navigator.clipboard?.writeText(url); alert('Link copied to clipboard'); } };
  qs('#btnReset').onclick=()=>{ if(confirm('Reset all data?')){ pushUndo(); db=seed(); save(); } };
  qs('#btnUndo').onclick=()=>undo();

  // Events
  qs('#btnLogKill').onclick=()=>{ const id=qs('#logAnimalSelect').value; const q=parseInt(qs('#logQuality').value,10); if(!id) return alert('Choose an animal'); logKillById(id,q); };
  qs('#btnQuickMat').onclick=()=>{ const item=prompt('Material (e.g., Silver Chain Bracelet)'); if(!item) return; const qty=parseInt(prompt('Quantity'),10)||1; pushUndo(); const row=db.inventory.materials.find(m=>m.item===item); if(row) row.qty+=qty; else db.inventory.materials.push({item,qty}); save(); };
  ['input','change'].forEach(ev=>{ qs('#qHunt').addEventListener(ev, renderAnimals); qs('#fltRegion').addEventListener(ev, renderAnimals); qs('#fltTime').addEventListener(ev, renderAnimals); });
  ['input','change'].forEach(ev=>{ qs('#mapQ').addEventListener(ev, ()=>drawMap('#map','#mapList','#mapQ','#mapFRegion','#mapFTime')); qs('#mapFRegion').addEventListener(ev, ()=>drawMap('#map','#mapList','#mapQ','#mapFRegion','#mapFTime')); qs('#mapFTime').addEventListener(ev, ()=>drawMap('#map','#mapList','#mapQ','#mapFRegion','#mapFTime')); });

  // Profile Save
  qs('#saveProfile').onclick=()=>{ db.profile.ownerName=qs('#ownerName').value.trim()||'Alley'; db.profile.cats=(qs('#cats').value||'').split(',').map(s=>s.trim()).filter(Boolean); db.profile.theme=qs('#theme').value||'green'; db.settings.spoilers=qs('#spoilers').checked; document.documentElement.setAttribute('data-theme', db.profile.theme); pushUndo(); save(); };
  qs('#clearPins').onclick=()=>{ pushUndo(); db.pins.animals=[]; db.pins.recipes=[]; db.pins.challenges=[]; save(); };
  (function(){ const hint=qs('#installHint'); const iOS=/iphone|ipad|ipod/i.test(navigator.userAgent); if(iOS) hint.textContent='Share ‚Üí Add to Home Screen'; })();

  // Boot
  document.documentElement.setAttribute('data-theme', db.profile?.theme||'green');
  renderTabs(); renderAll();
  </script>
</body>
</html>
